@page "/vpns/{vpn}/applicationdomains/{applicationDomain}/editor"
@using FaasNet.EventMesh.Client.StateMachines.Client
@using FaasNet.EventMesh.UI.Shared.AsyncApi
@using FaasNet.EventMesh.UI.Shared.Layout
@using FaasNet.EventMesh.UI.Stores.App
@using FaasNet.EventMesh.UI.Stores.ApplicationDomains
@using FaasNet.EventMesh.UI.Stores.Client
@using Fluxor
@using Fluxor.Blazor.Web.Components
@inherits FluxorComponent
@layout ApplicationDomainLayout

<Loader IsDisplayed="IsLoading">
    <AsyncApiEditor Vpn="@vpn" LoadingChanged="HandleLoadingChanged" @ref="Editor"></AsyncApiEditor>
</Loader>

@code {
    [Parameter] public string vpn { get; set; }
    [Parameter] public string applicationDomain { get; set; }
    private bool IsLoading { get; set; } = true;
    private AsyncApiEditor Editor { get; set; } = null;
    [Inject] private IDispatcher Dispatcher { get; set; } = null!;
    [Inject] private IState<AppState> AppState { get; set; } = null!;

    protected async override Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        SubscribeToAction<GetApplicationDomainResultAction>((act) =>
        {
            var applications = act.Content.Content.Elements.Select(e => new ApplicationViewModel
            {
                ClientId = e.ElementId,
                CreateDateTime = DateTime.UtcNow,
                Purposes = new List<ClientPurposeTypes>
                {
                    ClientPurposeTypes.PUBLISH,
                    ClientPurposeTypes.SUBSCRIBE
                }
            }).ToList();
            var links = BuildLinks(act);
            Editor.UpdateLinks(applications, links);
            IsLoading = false;
        });
        SubscribeToAction<SelectActiveNodeAction>((act) =>
        {
            RefreshApplications();
        });
        RefreshApplications();
    }

    private void RefreshApplications()
    {
        if (AppState.Value.SelectedNode == null) return;
        Dispatcher.Dispatch(new GetApplicationDomainAction { Name = applicationDomain, Vpn = vpn, Port = AppState.Value.SelectedNode.Port, Url = AppState.Value.SelectedNode.Url });
    }

    private void HandleLoadingChanged(bool isLoading)
    {
        IsLoading = isLoading;
    }

    private static ICollection<LinkViewModel> BuildLinks(GetApplicationDomainResultAction act)
    {
        var links = new List<LinkViewModel>();
        foreach (var client in act.Content.Content.Elements)
        {
            if (client.Targets == null || !client.Targets.Any()) continue;
            foreach (var target in client.Targets)
            {
                links.Add(new LinkViewModel
                {
                    EventId = target.EventId,
                    StartPoint = new LinkPointViewModel
                    {
                        ApplicationId = client.ElementId
                    },
                    EndPoint = new LinkPointViewModel
                    {
                        ApplicationId = target.Target
                    }
                });
            }
        }

        return links;
    }
}