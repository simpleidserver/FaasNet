<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Raft consensus </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Raft consensus ">
    <meta name="generator" content="docfx 2.59.2.0">
    
    <link rel="shortcut icon" href="../../../favicon.ico">
    <link rel="stylesheet" href="../../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../../styles/docfx.css">
    <link rel="stylesheet" href="../../../styles/main.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../../../toc.html">
    <meta property="docfx:tocrel" content="../../toc.html">
    
    
    
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../../index.html">
                <img id="logo" class="svg" src="../../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="raft-consensus">Raft consensus</h1>

<p>Raft consensus algorithm is used to build resilient, fault-tolerant, strongly-consistent distributed systems.</p>
<p>Applications like Apache Kafka are using Raft Consensus algorithm for both leader election and data replication.
Instead of having all the data stored in one Peer, they are duplicated among two or more Peers.</p>
<p>The algorithm is widely used :</p>
<ul>
<li>CockroachDB uses raft in the Replication layer.</li>
<li>MongoDB uses a variant of Raft in the replication set.</li>
</ul>
<p>In the context of Raft Consensus, a Peer can have one of the following status :</p>
<ul>
<li>Follower : issue no requests but simply respond to request from leaders and candidates.</li>
<li>Candidate : during the election process, ask to other Peers to become the leader. Candidate becomes the leader when it receives votes from majority of servers.</li>
<li>Leader : handle all client requests.</li>
</ul>
<p><img src="images/raftconsensus.png" alt="Raft consensus"></p>
<h2 id="quick-start">Quick start</h2>
<p>In this tutorial, we are going to explain how to use the C# library to have an up and running RAFT Consensus server.</p>
<p>Open a command prompt and create a console application.</p>
<pre><code>mkdir QuickStart
cd QuickStart

mkdir src
cd src

dotnet new console -n RaftConsensusServer
</code></pre>
<p>Install the Nuget package <code>FaasNet.RaftConsensus.Core</code>.</p>
<pre><code>cd RaftConsensusServer

dotnet add package FaasNet.RaftConsensus.Core
</code></pre>
<p>Add the console application into the Visual Studio Solution.</p>
<pre><code>cd ../..
dotnet new sln -n QuickStart
dotnet sln add ./src/RaftConsensusServer/RaftConsensusServer.csproj
</code></pre>
<p>Open the Visual Studio Solution and edit the <code>Program.cs</code> file.</p>
<p>Add a new procedure <code>LaunchRaftConsensusPeer(ConcurrentBag&lt;ClusterPeer&gt; clusterPeers, string nodeName, int port)</code>, it will be used to start one RAFT Consensus peer.</p>
<pre><code>private static IPeerHost LaunchRaftConsensusPeer(ConcurrentBag&lt;ClusterPeer&gt; clusterPeers, string nodeName = &quot;node1&quot;, int port = 5001)
{
    var path = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);
    var peerHost = PeerHostFactory.NewUnstructured(o =&gt; {
        o.Port = port;
    }, clusterPeers)
        .UseUDPTransport()
        .AddRaftConsensus(o =&gt;
        {
            o.ConfigurationDirectoryPath = Path.Combine(path, nodeName);
            o.LeaderCallback = () =&gt;
            {
                Console.WriteLine(&quot;There a is a leader&quot;);
            };
        })
        .Build();
    peerHost.Start();
    return peerHost;
}
</code></pre>
<p>Add a new procedure <code>AddLogEntry(int port)</code>, it will be used to add a log.</p>
<pre><code>private static async void AddLogEntry(int port)
{
    using (var raftConsensusClient = new UDPRaftConsensusClient(&quot;localhost&quot;, port))
        await raftConsensusClient.AppendEntry(Encoding.UTF8.GetBytes(&quot;value&quot;), CancellationToken.None);
}
</code></pre>
<p>Add a new procedure <code>DisplayLogs(int port)</code>, it will be used to display all the logs.</p>
<pre><code>private static async void DisplayLogs(int port)
{
    using (var raftConsensusClient = new UDPRaftConsensusClient(&quot;localhost&quot;, port))
    {
        var result = await raftConsensusClient.GetLogs(1, CancellationToken.None);
        foreach(var log in result.Entries)
        {
            Console.WriteLine($&quot;Index {log.Index}&quot;);
            Console.WriteLine($&quot;Term {log.Term}&quot;);
        }
    }
}
</code></pre>
<p>Add the following code to add two peers, publish one log and display all the logs.</p>
<pre><code>var firstPeer = LaunchRaftConsensusPeer(new ConcurrentBag&lt;ClusterPeer&gt; { new ClusterPeer(&quot;localhost&quot;, 5002) }, &quot;node1&quot;, 5001);
var secondPeer = LaunchRaftConsensusPeer(new ConcurrentBag&lt;ClusterPeer&gt; { new ClusterPeer(&quot;localhost&quot;, 5001) }, &quot;node2&quot;, 5002);
Console.WriteLine(&quot;Press any key to add an entry&quot;);
Console.ReadLine();
AddLogEntry(5002);
Console.WriteLine(&quot;Press any key to add an entry&quot;);
Console.ReadLine();
AddLogEntry(5002);
Console.WriteLine(&quot;Press any key to get logs of Peer 5001&quot;);
Console.ReadLine();
DisplayLogs(5001);
Console.WriteLine(&quot;Press any key to get logs of Peer 5002&quot;);
Console.ReadLine();
DisplayLogs(5002);
</code></pre>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/simpleidserver/FaasNet/blob/release/0.0.7/docs/documentation/p2p/unstructured/raftconsensus.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../styles/main.js"></script>
  </body>
</html>
